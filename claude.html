<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <style>
        html, body {width: 100%;height: 100%;margin: 0;padding: 0;}
        #map {position:absolute;top:0;bottom:0;right:0;left:0;}
        @keyframes fadeInGrow {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .agent-icon {
            animation: fadeInGrow 0.5s ease-out;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
</head>
<body>
    <div id="map"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map').setView([48.8566, 2.3522], 6); // Coordonnées de Paris, France

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            var agentIcon = L.divIcon({
                className: 'agent-icon',
                html: '<img src="agent.png" style="width:100%;height:100%;">',
                iconSize: [64, 64],
                iconAnchor: [32, 64],
                popupAnchor: [0, -64]
            });

            var employeeMarkers = {};
            var employeeLines = {};

            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(sitesData => {
                    console.log('Données JSON chargées:', sitesData);

                    sitesData.forEach(function(site) {
                        var siteMarker = L.circle([site.latitude, site.longitude], {
                            color: 'blue',
                            fillColor: 'blue',
                            fillOpacity: 0.5,
                            radius: 7000 // Rayon en mètres
                        }).addTo(map);

                        map.on('zoomend', function() {
                            var zoomLevel = map.getZoom();
                            var minRadius = 500; // Taille minimale en mètres
                            var maxRadius = 7000; // Taille initiale en mètres

                            var newRadius = minRadius + (maxRadius - minRadius) * Math.pow(0.001, (zoomLevel - 1) / (18 - 1));
                            siteMarker.setRadius(newRadius);
                        });

                        var content = `
                            <b>${site.site_name}</b><br>
                            <button class="toggle-employees" data-site-id="${site.site_id}" data-employees='${JSON.stringify(site.agents)}' data-lat="${site.latitude}" data-lon="${site.longitude}">Afficher/Masquer agents</button>
                        `;

                        siteMarker.bindPopup(content);
                    });

                    document.body.addEventListener('click', function(event) {
                        if (event.target.classList.contains('toggle-employees')) {
                            var siteId = event.target.getAttribute('data-site-id');
                            var employeesData = JSON.parse(event.target.getAttribute('data-employees'));
                            var siteLat = parseFloat(event.target.getAttribute('data-lat'));
                            var siteLon = parseFloat(event.target.getAttribute('data-lon'));
                            toggleEmployees(siteId, employeesData, siteLat, siteLon);
                        }
                    });

                    function toggleEmployees(siteId, employeesData, siteLat, siteLon) {
                        console.log("toggleEmployees called for site:", siteId);

                        if (!employeeMarkers[siteId]) {
                            employeeMarkers[siteId] = [];
                            employeeLines[siteId] = [];

                            var siteLatLng = { lat: siteLat, lng: siteLon };

                            employeesData.forEach(function(emp) {
                                var marker = L.marker([emp.latitude, emp.longitude], {
                                    icon: agentIcon
                                }).addTo(map);
                                marker.bindTooltip(emp.agent_name);
                                employeeMarkers[siteId].push(marker);

                                var line = L.polyline([[siteLatLng.lat, siteLatLng.lng], [emp.latitude, emp.longitude]], {
                                    color: '#ff0000',
                                    weight: 1
                                }).addTo(map);
                                employeeLines[siteId].push(line);

                                // Réinitialiser l'animation à chaque affichage
                                marker.getElement().style.animation = 'none';
                                marker.getElement().offsetHeight; // Forcer un reflow
                                marker.getElement().style.animation = null;
                            });
                        } else {
                            employeeMarkers[siteId].forEach(function(marker) {
                                if (map.hasLayer(marker)) {
                                    map.removeLayer(marker);
                                } else {
                                    map.addLayer(marker);
                                    // Réappliquer l'animation lors de la réapparition
                                    marker.getElement().style.animation = 'none';
                                    marker.getElement().offsetHeight; // Forcer un reflow
                                    marker.getElement().style.animation = null;
                                }
                            });
                            employeeLines[siteId].forEach(function(line) {
                                if (map.hasLayer(line)) {
                                    map.removeLayer(line);
                                } else {
                                    map.addLayer(line);
                                }
                            });
                        }
                    }

                    map.on('zoomend', function() {
                        var zoomLevel = map.getZoom();
                        var iconSize = [64, 64]; // Taille normale
                        if (zoomLevel > 6) {
                            iconSize = [32, 32]; // Taille après 3 niveaux de zoom
                        }
                        agentIcon.options.iconSize = iconSize;

                        for (var siteId in employeeMarkers) {
                            employeeMarkers[siteId].forEach(function(marker) {
                                marker.setIcon(agentIcon);
                            });
                        }
                    });
                })
                .catch(error => console.error('Erreur lors du chargement des données JSON:', error));
        });
    </script>
</body>
</html>
